
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Figure 4. Sleep vs. Wake &#8212; timescales 0.0.1-dev documentation</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script src="../_static/design-tabs.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Figure 4. Bias Solutions" href="fig04_bias_solutions.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">timescales 0.0.1-dev documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../api.html">
   API Documentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/index.html">
   Tutorials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   Figures
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/voytekresearch/timescale-methods"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#AR-PSD">
   AR-PSD
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Fit-Spectra:-Spikes">
   Fit Spectra: Spikes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Spike-Stats">
   Spike Stats
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Spikes-vs-LFPs">
   Spikes vs LFPs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Fit-Spectra:-LFP">
   Fit Spectra: LFP
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Plot">
   Plot
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Figure 4. Sleep vs. Wake</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#AR-PSD">
   AR-PSD
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Fit-Spectra:-Spikes">
   Fit Spectra: Spikes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Spike-Stats">
   Spike Stats
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Spikes-vs-LFPs">
   Spikes vs LFPs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Fit-Spectra:-LFP">
   Fit Spectra: LFP
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Plot">
   Plot
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import os.path as op

import matplotlib.pyplot as plt
import seaborn as sns

import numpy as np

from scipy.io import loadmat
from scipy.stats import ttest_ind, ttest_rel, pearsonr

from neurodsp.utils.norm import normalize_sig

from timescales.fit import PSD
from timescales.autoreg import compute_ar_spectrum
from timescales.plts import set_default_rc
from timescales.utils import create_windows

set_default_rc()
</pre></div>
</div>
</div>
<section id="Figure-4.-Sleep-vs. Wake">
<h1>Figure 4. Sleep vs. Wake<a class="headerlink" href="#Figure-4.-Sleep-vs. Wake" title="Permalink to this headline">¶</a></h1>
<p>The timescales, as knee frequencies, are compared between 4 types of spike trains and the local field potential:</p>
<ul class="simple">
<li><p>Wake : Excitatory Units</p></li>
<li><p>NREM : Excitatory Units</p></li>
<li><p>Wake : Inhibitory Units</p></li>
<li><p>NREM : Inhibitory Units</p></li>
<li><p>LFP Wake</p></li>
<li><p>LFP NREM</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def compute_spectra_trials(spikes_e, spikes_i, start_end, f_range,
                           bin_size, ar_order, kwargs_ar=None):
    &quot;&quot;&quot;Compute Welch&#39;s and AR PSD for exciatatory and inhibitory spikes.&quot;&quot;&quot;

    # Ensure unpackable
    if kwargs_ar is None:
        kwargs_ar = {}

    # Compute AR-PSD and Welch&#39;s-PSD for each window
    for ind, (s, e) in enumerate(start_end):

        # Normalize
        spikes_bin_e = normalize_sig(
            spikes_e[s:e].reshape(-1, bin_size).sum(axis=1), 0, 1)

        spikes_bin_i = normalize_sig(
            spikes_i[s:e].reshape(-1, bin_size).sum(axis=1), 0, 1)

        # Compute excitatory spectra
        freqs_ar, powers_ar_e = compute_ar_spectrum(spikes_bin_e, fs/bin_size, ar_order,
                                                    f_range=f_range, **kwargs_ar)

        # Compute inhibitory spectra
        _, powers_ar_i = compute_ar_spectrum(spikes_bin_i, fs/bin_size, ar_order,
                                             f_range=f_range, **kwargs_ar)

        # Initalize arrays
        if ind == 0:

            freqs = {&#39;ar&#39;: freqs_ar}

            powers = {
                &#39;ar&#39;: {&#39;excitatory&#39;: np.zeros((len(start_end), len(powers_ar_e))),
                       &#39;inhibitory&#39;: np.zeros((len(start_end), len(powers_ar_i)))}
            }

        powers[&#39;ar&#39;][&#39;excitatory&#39;][ind] = powers_ar_e
        powers[&#39;ar&#39;][&#39;inhibitory&#39;][ind] = powers_ar_i

    return freqs, powers
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Load data
base_name = &#39;20140526_277um&#39;
dir_path = f&#39;/home/rph/Projects/timescale-methods/fcx1/{base_name}&#39;

subtype_dict = loadmat(f&#39;{dir_path}/{base_name}_SSubtypes.mat&#39;)
subtype_e = subtype_dict[&#39;Se_CellFormat&#39;][0]
subtype_i = subtype_dict[&#39;Si_CellFormat&#39;][0]

fs = 20000

n_seconds = np.ceil(max([*[np.max(i) for i in subtype_i],
                         *[np.max(i) for i in subtype_e]]))

times = np.arange(0, n_seconds, 1/fs)

# Extract behavioral data
beh_file = f&#39;{dir_path}/{base_name}_WSRestrictedIntervals.mat&#39;
beh = loadmat(beh_file)

nrem = beh[&#39;SWSPacketTimePairFormat&#39;].astype(int) * fs
wake = beh[&#39;WakeTimePairFormat&#39;].astype(int) *  fs

# Window by trial type
win_len = int(5*fs)
win_spacing = int(5*fs)

wake_starts, wake_mids, wake_ends = create_windows(wake, win_len, win_spacing)
nrem_starts, nrem_mids, nrem_ends = create_windows(nrem, win_len, win_spacing)

start_end_wake = np.vstack((wake_starts, wake_ends)).T
start_end_nrem = np.vstack((nrem_starts, nrem_ends)).T
</pre></div>
</div>
</div>
<section id="AR-PSD">
<h2>AR-PSD<a class="headerlink" href="#AR-PSD" title="Permalink to this headline">¶</a></h2>
<p>The AR spectra are influences by the bin size and the AR order parameters. These parameters will influence the resulting timescales measurements. These spectra follow a Lorentzian form.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Sum spikes across E/I sub-units
spikes = np.zeros((2, int(n_seconds * fs)))

for sind, subtype in enumerate([subtype_e, subtype_i]):
    for s in subtype:
        spikes[sind, (s[:, 0] * fs).astype(int)] = 1

spikes_e = spikes[0]
spikes_i = spikes[1]

# Compute Spectra
f_range = (0, 100)
bin_size = 200
ar_order = 5

freqs_wake, powers_wake = compute_spectra_trials(
    spikes_e, spikes_i, start_end_wake, f_range, bin_size, ar_order
)

freqs_nrem, powers_nrem = compute_spectra_trials(
    spikes_e, spikes_i, start_end_nrem, f_range, bin_size, ar_order
)
</pre></div>
</div>
</div>
</section>
<section id="Fit-Spectra:-Spikes">
<h2>Fit Spectra: Spikes<a class="headerlink" href="#Fit-Spectra:-Spikes" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fooof_init = {
    &#39;aperiodic_mode&#39;: &#39;knee_constant&#39;,
    &#39;max_n_peaks&#39;: 4,
    &#39;peak_threshold&#39;: 2.5
}

bounds = [
    [-10, 1e-3, 1e-3, 1e-20],
    [ 10, 20,     10,  1e-2]
]

guess = [-2, 1, 1, 1e-2]

psd_ex_nrem = PSD(freqs_nrem[&#39;ar&#39;], powers_nrem[&#39;ar&#39;][&#39;excitatory&#39;])
psd_ex_nrem.fit(method=&#39;fooof&#39;, fooof_init=fooof_init, bounds=bounds, guess=guess,
                n_jobs=-1, progress=&#39;tqdm.notebook&#39;)

psd_in_nrem = PSD(freqs_nrem[&#39;ar&#39;], powers_nrem[&#39;ar&#39;][&#39;inhibitory&#39;])
psd_in_nrem.fit(method=&#39;fooof&#39;, fooof_init=fooof_init, bounds=bounds, guess=guess,
                n_jobs=-1, progress=&#39;tqdm.notebook&#39;)

psd_ex_wake = PSD(freqs_wake[&#39;ar&#39;], powers_wake[&#39;ar&#39;][&#39;excitatory&#39;])
psd_ex_wake.fit(method=&#39;fooof&#39;, fooof_init=fooof_init, bounds=bounds, guess=guess,
                n_jobs=-1, progress=&#39;tqdm.notebook&#39;)

psd_in_wake = PSD(freqs_wake[&#39;ar&#39;], powers_wake[&#39;ar&#39;][&#39;inhibitory&#39;])
psd_in_wake.fit(method=&#39;fooof&#39;, fooof_init=fooof_init, bounds=bounds, guess=guess,
                n_jobs=-1, progress=&#39;tqdm.notebook&#39;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "39ea89c1509a466fb1dbb48a5ec5aec4", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cb85d2f86ef74c169413aa006976415b", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8680550e8ad44aa39d347ee607d36a9b", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e62cabf40daf461bb2fc36262f5a27b2", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="Spike-Stats">
<h2>Spike Stats<a class="headerlink" href="#Spike-Stats" title="Permalink to this headline">¶</a></h2>
<p>The NREM trials have a significantly higher r-squared values, compared to the wake trails. Comparing the timescales between the two may be confounded by this.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># R-squared stats
print(&#39;Spike R-Squared Statistics\n&#39;)
print(&#39;Excitatory Wake: &#39;, &#39;mean =&#39;, psd_ex_wake.rsq_full.mean(),
      &#39;std =&#39;, psd_ex_wake.rsq_full.std())
print(&#39;Excitatory NREM: &#39;, &#39;mean =&#39;, psd_ex_nrem.rsq_full.mean(),
      &#39;std =&#39;, psd_ex_nrem.rsq_full.std())
print(&#39;Inhibitory Wake: &#39;, &#39;mean =&#39;, psd_in_wake.rsq_full.mean(),
      &#39;std =&#39;, psd_in_wake.rsq_full.std())
print(&#39;Inhibitory NREM: &#39;, &#39;mean =&#39;, psd_in_nrem.rsq_full.mean(),
      &#39;std =&#39;, psd_in_nrem.rsq_full.std())
print()
print(&#39;Excitatory: Wake vs NREM&#39;)
print(ttest_ind(psd_ex_wake.rsq_full, psd_ex_nrem.rsq_full))
print()
print(&#39;Inhibitory: Wake vs NREM&#39;)
print(ttest_ind(psd_in_wake.rsq_full, psd_in_nrem.rsq_full))
print()
print(&#39;Wake: Excitatory vs Inhibitory&#39;)
print(ttest_ind(psd_ex_wake.rsq_full, psd_in_wake.rsq_full))
print()
print(&#39;NREM: Excitatory vs Inhibitory&#39;)
print(ttest_ind(psd_ex_nrem.rsq_full, psd_in_nrem.rsq_full))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spike R-Squared Statistics

Excitatory Wake:  mean = 0.8237961930445714 std = 0.2165613580105497
Excitatory NREM:  mean = 0.9551133739885479 std = 0.0603757437890658
Inhibitory Wake:  mean = 0.7760963792622833 std = 0.23944804910263517
Inhibitory NREM:  mean = 0.9661529198146298 std = 0.04790972635594994

Excitatory: Wake vs NREM
Ttest_indResult(statistic=-13.386164016678734, pvalue=1.35224023375709e-37)

Inhibitory: Wake vs NREM
Ttest_indResult(statistic=-17.912471149298536, pvalue=3.90499537291248e-62)

Wake: Excitatory vs Inhibitory
Ttest_indResult(statistic=3.0494139674328213, pvalue=0.0023638115434466036)

NREM: Excitatory vs Inhibitory
Ttest_indResult(statistic=-3.312942925626916, pvalue=0.0009541012302210045)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Knee freq stats
print(&#39;Spike Knee Frequency Statistics\n&#39;)

print(&#39;Excitatory Wake: &#39;, &#39;mean =&#39;, psd_ex_wake.knee_freq.mean(),
      &#39;std =&#39;, psd_ex_wake.knee_freq.std())
print(&#39;Excitatory NREM: &#39;, &#39;mean =&#39;, psd_ex_nrem.knee_freq.mean(),
      &#39;std =&#39;, psd_ex_nrem.knee_freq.std())
print(&#39;Inhibitory Wake: &#39;, &#39;mean =&#39;, psd_in_wake.knee_freq.mean(),
      &#39;std =&#39;, psd_in_wake.knee_freq.std())
print(&#39;Inhibitory NREM: &#39;, &#39;mean =&#39;, psd_in_nrem.knee_freq.mean(),
      &#39;std =&#39;, psd_in_nrem.knee_freq.std())
print()
print(&#39;Excitatory: Wake vs NREM&#39;)
print(ttest_ind(psd_ex_wake.knee_freq, psd_ex_nrem.knee_freq))
print()
print(&#39;Inhibitory: Wake vs NREM&#39;)
print(ttest_ind(psd_in_wake.knee_freq, psd_in_nrem.knee_freq))
print()
print(&#39;Wake: Excitatory vs Inhibitory&#39;)
print(ttest_ind(psd_ex_wake.knee_freq, psd_in_wake.knee_freq))
print()
print(&#39;NREM: Excitatory vs Inhibitory&#39;)
print(ttest_ind(psd_ex_nrem.knee_freq, psd_in_nrem.knee_freq))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spike Knee Frequency Statistics

Excitatory Wake:  mean = 6.510950551944465 std = 4.246369610003782
Excitatory NREM:  mean = 4.648572040370361 std = 2.09479811903976
Inhibitory Wake:  mean = 4.9346724778701345 std = 2.5163170714229937
Inhibitory NREM:  mean = 4.060590712098375 std = 1.993919717180862

Excitatory: Wake vs NREM
Ttest_indResult(statistic=8.877601649374666, pvalue=3.2896066288641537e-18)

Inhibitory: Wake vs NREM
Ttest_indResult(statistic=6.00776424501637, pvalue=2.6662281322938156e-09)

Wake: Excitatory vs Inhibitory
Ttest_indResult(statistic=6.591249288074879, pvalue=7.637748207776019e-11)

NREM: Excitatory vs Inhibitory
Ttest_indResult(statistic=4.702579432003745, pvalue=2.904517412488611e-06)
</pre></div></div>
</div>
</section>
<section id="Spikes-vs-LFPs">
<h2>Spikes vs LFPs<a class="headerlink" href="#Spikes-vs-LFPs" title="Permalink to this headline">¶</a></h2>
<p>Spike versus LFP timescale comparison.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Load LFP
data_id = &#39;20140526_277um&#39;
data_dir = f&#39;/home/rph/Projects/timescale-methods/fcx1/data_mats/{data_id}&#39;
fs = 1250

# Infer shape using one channel
lfp_file = op.join(data_dir, &#39;data01.mat&#39;)
sig_len = len(loadmat(lfp_file)[&#39;data&#39;][0])

# Get PFC channels
channels = list(range(17, 49))
sig_lfp = np.zeros(sig_len)

for cind, ch in enumerate(channels):
    lfp_file = op.join(data_dir, f&#39;data{ch}.mat&#39;)
    sig_lfp += loadmat(lfp_file)[&#39;data&#39;][0]

sig_lfp = sig_lfp / len(channels)
sig_lfp =  normalize_sig(sig_lfp, 0, 1)

times = np.arange(0, len(sig_lfp)/fs, 1/fs)

# Windows
nrem = beh[&#39;SWSPacketTimePairFormat&#39;].astype(int) * fs
wake = beh[&#39;WakeTimePairFormat&#39;].astype(int) * fs

# Window by trial type
win_len = int(5*fs)
win_spacing = int(5*fs)

wake_starts, wake_mids, wake_ends = create_windows(wake, win_len, win_spacing)
nrem_starts, nrem_mids, nrem_ends = create_windows(nrem, win_len, win_spacing)

start_end_wake = np.vstack((wake_starts, wake_ends)).T
start_end_nrem = np.vstack((nrem_starts, nrem_ends)).T

# Create 2d arrays
sig_lfp_wake = np.array([sig_lfp[s:e] for s, e in
                         zip(wake_starts, wake_ends)])

sig_lfp_nrem = np.array([sig_lfp[s:e] for s, e in
                         zip(nrem_starts, nrem_ends)])
</pre></div>
</div>
</div>
</section>
<section id="Fit-Spectra:-LFP">
<h2>Fit Spectra: LFP<a class="headerlink" href="#Fit-Spectra:-LFP" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fooof_init = {
    &#39;aperiodic_mode&#39;: &#39;knee_constant&#39;,
    &#39;max_n_peaks&#39;: 4,
    &#39;peak_threshold&#39;: 2.5
}

bounds = [
    [-10, 1e-3, 1e-3, 1e-20],
    [ 10, 20,     10,  1e-2]
]

guess = [-2, 1, 1, 1e-2]

psd_lfp_wake = PSD()
psd_lfp_wake.compute_spectrum(sig_lfp_wake, fs, f_range=(0, 100), ar_order=10)
psd_lfp_wake.fit(method=&#39;fooof&#39;, fooof_init=fooof_init, bounds=bounds, guess=guess,
                 n_jobs=-1, progress=&#39;tqdm.notebook&#39;)

psd_lfp_nrem = PSD()
psd_lfp_nrem.compute_spectrum(sig_lfp_nrem, fs, f_range=(0, 100), ar_order=10)
psd_lfp_nrem.fit(method=&#39;fooof&#39;, fooof_init=fooof_init, bounds=bounds, guess=guess,
                 n_jobs=-1, progress=&#39;tqdm.notebook&#39;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "3b560768ef224062a269e2c172ac3c66", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a487bff5e4c84d8c991b373e4d94f4f8", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="Plot">
<h2>Plot<a class="headerlink" href="#Plot" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_overlapping_densities(df, xlim, overlap_hspace=-.5):

    sns.set_theme(style=&quot;white&quot;, rc={&quot;axes.facecolor&quot;: (0, 0, 0, 0)})

    # Initialize the FacetGrid object
    pal = sns.cubehelix_palette(6, rot=-.25, light=.5)

    grid = sns.FacetGrid(df, row=&quot;labels&quot;, hue=&quot;labels&quot;, aspect=10,
                         height=2, palette=pal, xlim=xlim)

    # Draw the densities in a few steps
    grid.map(sns.kdeplot, &quot;knees&quot;, clip_on=True,
             fill=True, alpha=1, linewidth=2)

    grid.map(sns.kdeplot, &quot;knees&quot;, clip_on=True, color=&quot;w&quot;, lw=2.5, bw_adjust=1)

    grid.refline(y=0, linewidth=2, linestyle=&quot;-&quot;, color=None, clip_on=False)

    # Label the plot in axes coordinates
    def label(x, color, label):
        ax = plt.gca()
        ax.text(0, .2, label, fontweight=&quot;bold&quot;, color=color,
                ha=&quot;left&quot;, va=&quot;center&quot;, transform=ax.transAxes, size=20)

    grid.map(label, &quot;knees&quot;)

    # Set the subplots to overlap
    grid.figure.subplots_adjust(hspace=overlap_hspace)

    # Remove axes details that don&#39;t play well with overlap
    grid.set_titles(&quot;&quot;)
    grid.set(yticks=[], ylabel=&quot;&quot;)
    grid.set(xticks=np.arange(0, xlim[1]+1))
    grid.despine(bottom=False, left=True)

    grid.set_xticklabels(np.arange(0, xlim[1]+1), size=24)
    grid.set_xlabels(&#39;Knee Frequency (Hertz)&#39;, size=28)

    return grid
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import pandas as pd

# Apply r-squared threshold
rsq_thresh = .25

nrem_inds = np.where(
    (psd_ex_nrem.rsq &gt; rsq_thresh) &amp;
    (psd_in_nrem.rsq &gt; rsq_thresh) &amp;
    (psd_lfp_nrem.rsq &gt; rsq_thresh)
)[0]

wake_inds = np.where(
    (psd_ex_wake.rsq &gt; rsq_thresh) &amp;
    (psd_in_wake.rsq &gt; rsq_thresh) &amp;
    (psd_lfp_wake.rsq &gt; rsq_thresh)
)[0]

# Merge knees
knees = np.concatenate([
    psd_lfp_nrem.knee_freq[nrem_inds],
    psd_ex_nrem.knee_freq[nrem_inds],
    psd_in_nrem.knee_freq[nrem_inds],
    psd_lfp_wake.knee_freq[wake_inds],
    psd_ex_wake.knee_freq[wake_inds],
    psd_in_wake.knee_freq[wake_inds]
])

# Merge labels
labels = [
    *[&#39;LFP : NREM&#39;] * len(nrem_inds),
    *[&#39;Spikes : Excitatory : NREM&#39;] * len(nrem_inds),
    *[&#39;Spikes : Inhibitory : NREM&#39;] * len(nrem_inds),
    *[&#39;LFP : Wake&#39;] * len(wake_inds),
    *[&#39;Spikes : Excitatory : Wake&#39;] * len(wake_inds),
    *[&#39;Spikes : Inhibitory : Wake&#39;] * len(wake_inds)
]

# To dataframe
df = pd.DataFrame(dict(knees=knees, labels=labels))
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Plot
plot_overlapping_densities(df, (-4, 12), overlap_hspace=-0.75)

plt.savefig(&#39;fig05_sleep_vs_wake.png&#39;, dpi=300, facecolor=&#39;w&#39;);
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/figures_fig05_sleep_vs_wake_18_0.png" src="../_images/figures_fig05_sleep_vs_wake_18_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&#39;Wake&#39;)
print(f&#39;LFP               : mean={psd_lfp_wake.knee_freq[wake_inds].mean()}, &#39;\
      f&#39;std={psd_lfp_wake.knee_freq[wake_inds].std()}&#39;)

print(f&#39;Spikes, Excitatory: mean={psd_ex_wake.knee_freq[wake_inds].mean()}, &#39;\
      f&#39;std={psd_ex_wake.knee_freq[wake_inds].std()}&#39;)

print(f&#39;Spikes, Inhibitory: mean={psd_in_wake.knee_freq[wake_inds].mean()}, &#39;\
      f&#39;std={psd_in_wake.knee_freq[wake_inds].std()}&#39;)

print()

print(f&#39;NREM&#39;)

print(f&#39;LFP               : mean={psd_lfp_nrem.knee_freq[nrem_inds].mean()}, &#39;\
      f&#39;std={psd_lfp_nrem.knee_freq[nrem_inds].std()}&#39;)

print(f&#39;Spikes, Excitatory: mean={psd_ex_nrem.knee_freq[nrem_inds].mean()}, &#39;\
      f&#39;std={psd_ex_nrem.knee_freq[nrem_inds].std()}&#39;)

print(f&#39;Spikes, Inhibitory: mean={psd_in_nrem.knee_freq[nrem_inds].mean()}, &#39;\
      f&#39;std={psd_in_nrem.knee_freq[nrem_inds].std()}&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Wake
LFP               : mean=6.8001364891954, std=2.656403888980302
Spikes, Excitatory: mean=6.15023882411311, std=3.816180868647709
Spikes, Inhibitory: mean=4.5061781442512405, std=1.6995762892176098

NREM
LFP               : mean=3.1374131726642167, std=1.4539461558915583
Spikes, Excitatory: mean=4.622147400058879, std=2.005520664967615
Spikes, Inhibitory: mean=4.061209976351796, std=1.9957308268995413
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&#39;Wake vs NREM&#39;)
print(&#39;LFP       : &#39;, ttest_ind(psd_lfp_wake.knee_freq[wake_inds],
                                psd_lfp_nrem.knee_freq[nrem_inds]))

print(&#39;Excitatory: &#39;, ttest_ind(psd_ex_wake.knee_freq[wake_inds],
                                psd_ex_nrem.knee_freq[nrem_inds]))

print(&#39;Inhibitory: &#39;, ttest_ind(psd_in_wake.knee_freq[wake_inds],
                                psd_in_nrem.knee_freq[nrem_inds]))

print()
print(&#39;Wake&#39;)
print(&#39;LFP vs Excitatory:&#39;, ttest_rel(psd_lfp_wake.knee_freq[wake_inds],
                                      psd_ex_wake.knee_freq[wake_inds]))

print(&#39;LFP vs Inhibitory:&#39;, ttest_rel(psd_lfp_wake.knee_freq[wake_inds],
                                      psd_in_wake.knee_freq[wake_inds]))
print()
print(f&#39;NREM&#39;)
print(&#39;LFP vs Excitatory:&#39;, ttest_rel(psd_lfp_nrem.knee_freq[nrem_inds],
                                      psd_ex_nrem.knee_freq[nrem_inds]))

print(&#39;LFP vs Inhibitory:&#39;, ttest_rel(psd_lfp_nrem.knee_freq[nrem_inds],
                                      psd_in_nrem.knee_freq[nrem_inds]))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Wake vs NREM
LFP       :  Ttest_indResult(statistic=26.21179265308087, pvalue=4.76513474449946e-112)
Excitatory:  Ttest_indResult(statistic=7.709989328694835, pvalue=3.438514642092187e-14)
Inhibitory:  Ttest_indResult(statistic=3.38372695420238, pvalue=0.000747082004084111)

Wake
LFP vs Excitatory: Ttest_relResult(statistic=2.576773510327446, pvalue=0.010400209973630595)
LFP vs Inhibitory: Ttest_relResult(statistic=13.76100417988951, pvalue=1.837967809311979e-34)

NREM
LFP vs Excitatory: Ttest_relResult(statistic=-15.57977377129755, pvalue=2.1891548411738475e-45)
LFP vs Inhibitory: Ttest_relResult(statistic=-12.6061404963828, pvalue=4.4365469496275713e-32)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&#39;Correlation&#39;)

print(&#39;Wake: LFP vs Excitatory: r={:.4f}, p={:.4f}&#39;.format(
    *pearsonr(psd_lfp_wake.knee_freq[wake_inds], psd_ex_wake.knee_freq[wake_inds]))
)

print(&#39;Wake: LFP vs Inhibitory: r={:.4f}, p={:.4f}&#39;.format(
    *pearsonr(psd_lfp_wake.knee_freq[wake_inds], psd_in_wake.knee_freq[wake_inds]))
)

print()

print(&#39;NREM: LFP vs Excitatory: r={:.4f}, p={:.4f}&#39;.format(
    *pearsonr(psd_lfp_nrem.knee_freq[nrem_inds], psd_ex_nrem.knee_freq[nrem_inds]))
)

print(&#39;NREM: LFP vs Inhibitory: r={:.4f}, p={:.4f}&#39;.format(
    *pearsonr(psd_lfp_nrem.knee_freq[nrem_inds], psd_in_nrem.knee_freq[nrem_inds]))
)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Correlation
Wake: LFP vs Excitatory: r=0.0153, p=0.7802
Wake: LFP vs Inhibitory: r=0.0704, p=0.1979

NREM: LFP vs Excitatory: r=0.2206, p=0.0000
NREM: LFP vs Inhibitory: r=0.5564, p=0.0000
</pre></div></div>
</div>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="fig04_bias_solutions.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Figure 4. Bias Solutions</p>
        </div>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Ryan Hammonds<br/>
  
      &copy; Copyright 2021-2023, VoytekLab.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  

  </body>
</html>